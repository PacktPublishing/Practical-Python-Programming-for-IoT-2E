<!DOCTYPE html>
<html>

<head>
    <title>Microdot Web Socket Example</title>
    <script src="/static/jquery.min.js"></script>
    <script type="text/javascript">

        const socket = new WebSocket('ws://' + location.host + '/led')           // (X)

        socket.addEventListener('open', ev => {                                // (X)
            console.log("Connected to Server")
            $("#connected").html("Yes")

            // Initialise web page controls.
            // Send empty JSON object and server will respond with the current.
            // brightness level.
            socket.send("{}")
        })

        socket.addEventListener('closed', ev => {                                // (X)
            console.log("Disconnected from the Server")
            $("#connected").html("No")
        })

        socket.addEventListener('message', ev => {                                // (X)
            dataFromServer = ev.data
            console.log(dataFromServer)

            data = JSON.parse(dataFromServer) // string to JSON Object.

            if (data.level !== undefined) {
                $("input[type=range].brightnessLevel").val(data.level)
                $("#brightnessLevel").html(data.level)
            }

            if (data.gpio !== undefined) {
                $("#gpio").html(data.gpio)
            }
        })

        $(document).ready(function () {                                        // (X)

            // @TODO REMOVE
            // Make a HTTP GET RESTful request to server to get GPIO
            // and update Web Page.
            // $.get("/gpio", function (serverResponse, status) {                 // (X)
            //     const gpio = serverResponse
            //     $("#gpio").html(gpio)
            // })

            // Event listener for Slider value changes.
            $("input[type=range].brightnessLevel").on('input', function () {
                level = parseInt($(this).val())
                payload = JSON.stringify({ "level": level })
                socket.send(payload)
            })
        });
    </script>
</head>

<body>
    <h1>Microdot Web Socket Example</h1>
    LED is connected to GPIO <span id="gpio">-</span><br> <!-- (X) -->
    Connected to server: <span id="connected">No</span> <!-- (X) -->
    <br><br>
    Brightness <span id="brightnessLevel"></span>:<br>
    <input type="range" min="0" max="100" value="0" class="brightnessLevel">
</body>

</html>